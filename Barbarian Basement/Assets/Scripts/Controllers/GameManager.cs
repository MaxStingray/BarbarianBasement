using System.Collections;
using UnityEngine;

public class GameManager : MonoBehaviour
{
    public static GameManager Instance;
    [SerializeField] private DunGen _dungeonGenerator;
    [SerializeField] private CharacterSheet _player;

    public CharacterSheet Player => _player;

    [SerializeField] private EnemyManager _enemyManager;

    //the grid generated by DunGen, passed here before GameReady is true
    public GameTile[,] FinalGrid { get; private set; }

    public bool GameReady { get; private set; }

    void Awake()
    {
        if (Instance != null)
        {
            Destroy(Instance);
        }

        Instance = this;
    }

    IEnumerator Start()
    {
        _dungeonGenerator.GenerateDungeon();

        while (ValidateGameReady() == false)
        {
            yield return null;
        }
        FinalGrid = _dungeonGenerator.Grid;
        if (_player == null)
        {
            Debug.LogError("player null");
        }
        _player.gameObject.transform.position = _dungeonGenerator.PlayerSpawnPosition;
        _player.CurrentTile = _dungeonGenerator.PlayerStartTile;
        _dungeonGenerator.PlayerStartTile.IsOccupied = true;
        _dungeonGenerator.PlayerStartTile.OccupiedBy = _player;
        //spawn enemies
        _enemyManager.SpawnEnemies(FinalGrid);
    }

    private bool ValidateGameReady()
    {
        if (_dungeonGenerator.DungeonGenerated)
        {
            return GameReady = true;
        }

        return false;
    }
}
